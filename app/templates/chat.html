<!doctype html>
<html>
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" />

<head>
  <title>moyachat</title>

  <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="//cdn.socket.io/4.4.1/socket.io.min.js"></script>
  <script type="text/javascript" charset="utf-8">
    let socket;
    // stolen from stackoverflow : )
    function timeDifference(current, previous) {

      var msPerMinute = 60 * 1000;
      var msPerHour = msPerMinute * 60;
      var msPerDay = msPerHour * 24;
      var msPerMonth = msPerDay * 30;
      var msPerYear = msPerDay * 365;

      var elapsed = current - previous;

      if (elapsed < msPerMinute) {
        return Math.round(elapsed / 1000) + ' secs';
      }

      else if (elapsed < msPerHour) {
        return Math.round(elapsed / msPerMinute) + ' min';
      }

      else if (elapsed < msPerDay) {
        return Math.round(elapsed / msPerHour) + ' hr';
      }

      else if (elapsed < msPerMonth) {
        return '~ ' + Math.round(elapsed / msPerDay) + ' days';
      }

      else if (elapsed < msPerYear) {
        return '~ ' + Math.round(elapsed / msPerMonth) + ' months';
      }

      else {
        return '~ ' + Math.round(elapsed / msPerYear) + ' yrs';
      }
    }

    // for adding new messages
    function appendHtml(el, str) {
      var div = document.createElement('div');
      div.innerHTML = str;
      while (div.children.length > 0) {
        el.appendChild(div.children[0]);
      }
      return div;
    }

    function pictosend() {
      if ($("#text").val() && $("#nick").val()) {
        sendMsg();
        var sound = document.getElementById("psnd_send");
        sound.play();
      } else { // nickname and message fields are empty
        var sound = document.getElementById("psnd_inv");
        sound.play();
      }
    }

    function sendMsg() {
      text = $('#text').val();
      nick = $('#nick').val();
      $('#text').val('');
      socket.emit('text', { msg: text, name: nick || 'user' });
    }

    function mDel(messageId) {
      socket.emit('mdel', { mid: messageId });
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    $(document).ready(function () {
      const socketPath = window.location.pathname.startsWith('/chat_devel') ? '/socket_devel.io/' : '/socket.io/';

      socket = io.connect('https://' + document.domain, {
        path: socketPath
      });

      var my_uid = "{{ sess }}";
      var youIndicator = "";
      var myname = "{{ name }}";

      $('#nick').val("{{ name }}")

      function insertChatMessage(msgId, content, authorUid, authorNick, msgDate) {
        youIndicator = (authorUid == my_uid) ? '<b>(YOU)</b>' : '';
        appendHtml(document.getElementById('messagebox'), 
          `<div class='message' id='m '>${msgId}<div class='messagei'>${youIndicator} ${authorNick}: ${content.replaceAll('[br]', '<br>')}<div class='messagetime'>` +
          {% if is_op or sess == authorUid %}
            `<a class='messagetime_a' onclick='mDel(${msgId})'>[ del ]</a>` +
          {% endif %}
          `${timeDifference(new Date().getTime(), new Date(msgDate + 'Z').getTime())}</div></div></div>`);
      }
    
    // load message history
    // todo: paginated load
    {% if history | length > 200 %}
    appendHtml(document.getElementById('messagebox'), "<div class='message'><div class='messagei'>... (history truncated)</div></div>");
    {% endif %}

    {% for item in history %}
    insertChatMessage("{{ item[0] }}", "{{ item[3] }}", "{{ item[2] }}", "{{ item[4] }}", " {{ item[1] }}");
    {% endfor %}

    $("#messagebox").animate({ scrollTop: $('#messagebox')[0].scrollHeight }, 0);
    socket.on('connect', function () {
      socket.emit('joined', {});
    });

    socket.on('status', function (data) {
      d = new Date();
    });

    socket.on('deleted', function (data) {
      if ($("#messagebox").scrollTop() + $("#messagebox").height() >= $("#messagebox")[0].scrollHeight - 2) {
        $("#messagebox").animate({ scrollTop: $('#messagebox')[0].scrollHeight - 178.0 - $('#m' + data.mid).height() }, 250, function () {
          $("#m" + data.mid).remove()
        });
      } else {
        $("#m" + data.mid).remove()
      }

      var sound = document.getElementById("psnd_clr");
      sound.play();
    });

    socket.on('message', function (data) {
      d = new Date();
      if (data.msg == "<<magicdone>>") {
        var sound = document.getElementById("psnd_join");
        sound.play();
      } else {
        var my_uid = "{{ sess }}";
        var youIndicator = (data.uid == my_uid) ? '<b>(YOU)</b>' : '';
        var created = appendHtml(document.getElementById('messagebox'), `<div class='message' id='m"${data.mmid}"''><div class='messagei'>"${youIndicator} ${escapeHtml(data.nick + ": " + data.msg)}</div></div>`);

        if (created) {
          // mimick nds pictochat animation
          $("#messagebox").animate({ scrollTop: $('#messagebox')[0].scrollHeight }, 500);
          if (data.uid != my_uid) {
            var sound = document.getElementById("psnd_recv");
            sound.play();
          }
        }
      }
    });

    $('#text').keypress(function (e) {
      const code = e.keyCode || e.which;
      if (code == 13) { // RETURN
        pictosend();
      }
    });

    function leave_room() {
      socket.emit('left', {}, function () {
        socket.disconnect();
      });
    }
    });
  </script>
  <!-- CSS reset. -->
  <style>
    /* http://meyerweb.com/eric/tools/css/reset/ 
   v2.0 | 20110126
   License: none (public domain)
    */

    html,
    body,
    div,
    span,
    applet,
    object,
    iframe,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    p,
    blockquote,
    pre,
    a,
    abbr,
    acronym,
    address,
    big,
    cite,
    code,
    del,
    dfn,
    em,
    img,
    ins,
    kbd,
    q,
    s,
    samp,
    small,
    strike,
    strong,
    sub,
    sup,
    tt,
    var,
    b,
    u,
    i,
    center,
    dl,
    dt,
    dd,
    ol,
    ul,
    li,
    fieldset,
    form,
    label,
    legend,
    table,
    caption,
    tbody,
    tfoot,
    thead,
    tr,
    th,
    td,
    article,
    aside,
    canvas,
    details,
    embed,
    figure,
    figcaption,
    footer,
    header,
    hgroup,
    menu,
    nav,
    output,
    ruby,
    section,
    summary,
    time,
    mark,
    audio,
    video {
      margin: 0;
      padding: 0;
      border: 0;
      font-size: 100%;
      font: inherit;
      vertical-align: baseline;
    }

    /* HTML5 display-role reset for older browsers */
    article,
    aside,
    details,
    figcaption,
    figure,
    footer,
    header,
    hgroup,
    menu,
    nav,
    section {
      display: block;
    }

    body {
      line-height: 1;
    }

    ol,
    ul {
      list-style: none;
    }

    blockquote,
    q {
      quotes: none;
    }

    blockquote:before,
    blockquote:after,
    q:before,
    q:after {
      content: '';
      content: none;
    }

    table {
      border-collapse: collapse;
      border-spacing: 0;
    }
  </style>
  <style>
    body::after {
      position: absolute;
      width: 0;
      height: 0;
      overflow: hidden;
      z-index: -1;
      content: url('./chat/static/send1.gif') url('./chat/static/send2.gif');
    }

    body {
      width: 400px;
      height: 300px;
    }

    b {
      font-weight: bold;
    }

    *,
    html,
    div,
    span {
      font-family: msp;
      image-rendering: optimizeSpeed;
      image-rendering: -moz-crisp-edges;
      image-rendering: -o-crisp-edges;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      image-rendering: optimize-contrast;
      -ms-interpolation-mode: nearest-neighbor;
      -moz-osx-font-smoothing: none;
      font-smooth: never;
      -webkit-font-smoothing: none;
      -webkit-text-size-adjust: none;
      text-size-adjust: none;
    }

    body {
      margin-left: 2px;
      margin-bottom: 25px;
      overflow: hidden;
    }

    @font-face {
      font-family: msp;
      src: local('MS Pゴシック'), local('MS PGothic'), url('https://moya.cafe/font/mspgoth.ttf');
    }

    .message,
    .inpbox {
      min-height: 14px;
      font-size: 13px;
      width: 377px;
      overflow-x: hidden;
      background-color: #fafcff;
    }

    .message {}

    #pictobox {
      height: 212px;
      width: 400px;
      overflow: hidden;
      position: absolute;
    }

    #messagebox {
      height: 172px;
      width: 374px;
      margin-left: 0px;
      padding-left: 8px;
      padding-bottom: 6px;
      overflow-x: hidden;
      overflow-y: scroll;
    }

    #sidebar {
      background-color: #ff0000;
      width: 18px;
      height: 210px;
      float: left;
    }

    .message:nth-child(2n) {
      background-color: #e9e9e9;
    }

    .message:hover {
      background-color: #f1fcff;
      color: #6f8097;
      font-family: msp;
      image-rendering: optimizeSpeed;
      image-rendering: -moz-crisp-edges;
      image-rendering: -o-crisp-edges;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      image-rendering: optimize-contrast;
      -ms-interpolation-mode: nearest-neighbor;
      -moz-osx-font-smoothing: none;
      font-smooth: never;
      -webkit-font-smoothing: none;
      -webkit-text-size-adjust: none;
      text-size-adjust: none;
    }

    .inpbox {
      background-color: #fafafa;
      width: 350px;
      padding: 0;
      padding-left: 6px;
      -webkit-box-sizing: border-box; /* Safari/Chrome, other WebKit */
    -moz-box-sizing: border-box;    /* Firefox, other Gecko */
    box-sizing: border-box; 
    }

    #nick.inpbox {
      border: 1px solid #494949;
      border-bottom: 0px none;
      border-right: 0px;
      top: 0px;
      height: 15px;

      position: absolute;
    }

    #text.inpbox {
      border: 1px solid #494949;
      border-top: 1px solid #e9e9e9;
      border-right: 0px;
      top: 17px;
      height: 16px;
      position: absolute;
      padding: 0;
      padding-left: 6px;
      -webkit-box-sizing: border-box; /* Safari/Chrome, other WebKit */
    -moz-box-sizing: border-box;    /* Firefox, other Gecko */
    box-sizing: border-box; 
    }

    .message {
      font-family: msp;
      position: relative;
      max-width: 395px !important;
    }



    .admindel {
      cursor: pointer;
      position: absolute;
      right: 6px;
    }

    .messagetime {
      text-align: right;
      position: absolute;
      color: #a0a0a0;
      right: 24px;
      top: 0px;
    }

    .messagetime:hover {
      color: #fff;
    }

    .messagetime:hover>.messagetime_a {
      display: block;
      pointer-events: all;
    }

    .messagetime_a {
      display: none;
      color: blue;
      position: absolute;
      right: 4px;
      cursor: pointer;

      white-space: nowrap;
      width: 128px;
    }

    .messagetime_a:active {
      color: red;
    }

    .messagei {
      max-width: 330px !important;
      width: 330px !important;
      overflow-wrap: break-word;
    }

    a:visited {
      text-decoration: none;
      color: red;
    }

    a {
      text-decoration: none;
    }

    #inputparent {
      width: 382px;
      height: 32px;
      position: absolute;
      
      bottom: -30px;
    }

    #inputparent-tb {
      width: 350px;
      padding: 0;
      margin: 0;
      float: left;
      position: relative;
    }

    #btsend {
      border: 0px;
      height: 32px;
      width: 32px;
      background: url('/chat/static/send1.gif');
      white-space: nowrap;
      display: inline-flex;
      float: right;
      top: 0;
      padding: 0;
    }

    #btsend:active {
      background: url('/chat/static/send2.gif');
    }

    #mcontainer {
      position: absolute;
      left: 18px;
      background-color: #fafafa;
    }

    textarea:focus,
    input:focus {
      outline: none;
      background-color: #dbdbdb;
    }

    #pictoframe {
      width: 400px;
      height: 211px;
      background: url('/chat/static/frame.gif');
      background-repeat: no-repeat;
      position: absolute;
      pointer-events: none;
    }
  </style>
</head>

<body>
  <audio id="psnd_send" src="/chat/static/pictochat_send.wav" autoplay="false"></audio>
  <audio id="psnd_recv" src="/chat/static/pictochat_receive.wav" autoplay="false"></audio>
  <audio id="psnd_clr" src="/chat/static/pictochat_clear.wav" autoplay="false"></audio>
  <audio id="psnd_join" src="/chat/static/pictochat_enterroom.wav" autoplay="false"></audio>
  <audio id="psnd_inv" src="/chat/static/invalid.wav" autoplay="false"></audio>
  <div id="pictobox">
    <div id="sidebar">
    </div>
    <div id="mcontainer">
      <div id="messagebox">
      </div>
      <div id="inputparent">
        <div id="inputparent-tb">
          <input id="nick" class="inpbox" maxlength="24" placeholder="名 「name」">

          <input id="text" class="inpbox" maxlength="280" placeholder="メッセージ 「message」">
        </div>
        <button id="btsend" onclick="pictosend()"></button>
      </div>
    </div>
  </div>
  <div id="pictoframe"></div>
  <!-- <h3>debug info</h3>
  {% for item in history %}
  <div id="message">{{ item }}</div><br>
  {% endfor %} -->
</body>

</html>